#!/bin/bash

. ${__ROOTFS__}/etc/upgrade/dir.in
. ${__ROOTFS__}/etc/upgrade/upgrade.in

#
# check the file hi_kernel.bin
#
check_kernel_file() {
    local version=$1; shift 1
    local kernel_file_path=${dir_md_rsync}/${version}/rootfs/image
    local kernel_file=${kernel_file_path}/hi_kernel.bin

    if [[ -f ${kernel_file} ]];then
        return 0
    else
        upgrade_echo_logger "kernel_upgrade" \
            "version=${version} hi_kernel.bin is not exist"
        return 1
    fi
}
#
# check the file /etc/.kversion
#
check_kversion_file() {
    local version=$1; shift 1
    local kernel_file_path=${dir_md_rsync}/${version}/rootfs/etc
    local kversion_file=${kernel_file_path}/.kversion

    if [[ -f ${kversion_file} ]];then
        return 0
    else
        upgrade_echo_logger "kernel_upgrade" \
            "version=${version} .kversion is not exist"
        return 1
    fi
}
#
# check the state of acc
#
check_acc_state() {
    local ret=""
    local acc_file=/data/acc_off.txt

    ls ${acc_file} >/dev/null 2>&1; ret=$?
    if [[ ${ret} -ne 0 ]];then
        return 0
    else
        return 1
    fi
}
#
# upgrade the kernel, dd of=/dev/mmcblk0p6 if=
#
do_upgrade_kernel() {
    local version=$1
    local kernel_file_path=${dir_md_rsync}/${version}/rootfs/image
    local kernel_file=hi_kernel.bin
    local ret=""

    upgrade_echo_logger "kernel_upgrade" \
    	"upgrade start......"
    dd of=/dev/mmcblk0p6 if=${kernel_file_path}/${kernel_file}; ret=$?
    if [[ ${ret} -eq 0 ]];then
        upgrade_echo_logger "kernel_upgrade" \
        	"upgrade OK"
        return 0
    else
	    upgrade_echo_logger "kernel_upgrade" \
        	"upgrade fail: dd error"
    	return 1
    fi
}
#
# check the state of acc, and ugrade kernel version
#
upgrade_kernel() {
    local version=$1
    local ret=""

    check_acc_state; ret=$?
    if [[ ${ret} -eq 0 ]];then
        upgrade_echo_logger "kernel_upgrade" \
            "need upgrade kernel"
         do_upgrade_kernel ${version}
    else
        upgrade_echo_logger "kernel_upgrade" \
            "upgrade fail: ACC OFF"
        return 1
    fi
}
#
# get the new kernel time
#
get_new_kernel_time() {
    local version=$1; shift 1
    local kernel_file_path=${dir_md_rsync}/${version}/rootfs/etc
    local kversion_file=${kernel_file_path}/.kversion
    local new_kernel_time=$(cat ${kversion_file} 2>/dev/null)
    local kernel_time=$(date -d "${new_kernel_time}" -u +'%F')

    echo ${kernel_time}
}
#
# get the kernel time of the curerent version
# change the time to YY-MM-DD-hh:mm:ss
#
get_uname_time(){
    local var=$(uname -v |awk -F 'SMP ' '{print $2}' 2>/dev/null)
    #local var="Mon Jun 8 13:59:18 EDT 2015"
    local time=$(date -d "${var}" -u +'%F')

    echo ${time}
}
#
# Compare the new version and old version of the time
# When the new time is greater than the old time, upgrade the kernel
#
compare_uname_time() {
    local version=$1
    local uname_time=$(get_uname_time)
    local new_time=$(get_new_kernel_time ${version})

    if [[ ${uname_time} < ${new_time} ]];then
        upgrade_kernel ${version}
    else
        upgrade_echo_logger "kernel_upgrade" \
            "not need upgrade kernel"
    fi
}

